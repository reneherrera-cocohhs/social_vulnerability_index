# reproduction of social vulnerability r master script

# setup 
# load packages 
library(here)
library(knitr)
library(sp)
library(sf)
library(spdep)
library(tidycensus)
library(dplyr)
library(tidyr)
library(mapview)
library(RColorBrewer)
library(leaflet)
library(leafpop)
library(ggplot2)
library(data.table)
library(tidyverse)

v19 <- load_variables(year = 2019, dataset = "acs5", cache = TRUE)

# load ACS variables of interest: 
vars <-
  c(
    # TENURE
    'B25003_001', # Estimate!!Total:
    'B25003_003', # Estimate!!Total:!!Renter occupied
    # GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME IN THE PAST 12 MONTHS 
    'B25070_007', #Estimate!!Total:!!30.0 to 34.9 percent
    'B25070_008', # Estimate!!Total:!!35.0 to 39.9 percent
    'B25070_009', # Estimate!!Total:!!40.0 to 49.9 percent
    'B25070_010', # Estimate!!Total:!!50.0 percent or more
    # MEDIAN GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME IN THE PAST 12 MONTHS (DOLLARS)
    'B25071_001', # Estimate!!Median gross rent as a percentage of household income
    # HOUSEHOLDS BY PRESENCE OF PEOPLE 65 YEARS AND OVER, HOUSEHOLD SIZE AND HOUSEHOLD TYPE
    'B11007_001', # Estimate!!Total:
    'B11007_003', # Estimate!!Total:!!Households with one or more people 65 years and over:!!1-person household
    # YEAR STRUCTURE BUILT
    'B25034_001', # Estimate!!Total:
    'B25034_008', # Estimate!!Total:!!Built 1960 to 1969
    'B25034_009', # Estimate!!Total:!!Built 1950 to 1959
    'B25034_010', # Estimate!!Total:!!Built 1940 to 1949
    'B25034_011', # Estimate!!Total:!!Built 1939 or earlier
    # TOTAL POPULATION
    'B01003_001', # Estimate!!Total
    # PER CAPITA INCOME IN THE PAST 12 MONTHS (IN 2019 INFLATION-ADJUSTED DOLLARS)
    'B19301_001', # Estimate!!Per capita income in the past 12 months (in 2019 inflation-adjusted dollars)
    # TOTAL POPULATION IN OCCUPIED HOUSING UNITS BY TENURE BY UNITS IN STRUCTURE
    'B25033_001', # Estimate!!Total:
    'B25033_006', # Estimate!!Total:!!Owner occupied:!!Mobile home
    'B25033_007', # Estimate!!Total:!!Owner occupied:!!Boat, RV, van, etc.
    'B25033_012', # Estimate!!Total:!!Renter occupied:!!Mobile home
    'B25033_013', # Estimate!!Total:!!Renter occupied:!!Boat, RV, van, etc.
    # TENURE BY VEHICLES AVAILABLE
    'B25044_001', # Estimate!!Total:
    'B25044_003', # Estimate!!Total:!!Owner occupied:!!No vehicle available
    'B25044_010', # Estimate!!Total:!!Renter occupied:!!No vehicle available
    # EMPLOYMENT STATUS FOR THE POPULATION 16 YEARS AND OVER
    'B23025_003', # Estimate!!Total:!!In labor force:!!Civilian labor force:
    'B23025_005', # Estimate!!Total:!!In labor force:!!Civilian labor force:!!Unemployed
    # TENURE BY OCCUPANTS PER ROOM
    'B25014_001', # Estimate!!Total:
    'B25014_005', # Estimate!!Total:!!Owner occupied:!!1.01 to 1.50 occupants per room
    'B25014_006', # Estimate!!Total:!!Owner occupied:!!1.51 to 2.00 occupants per room
    'B25014_007', # Estimate!!Total:!!Owner occupied:!!2.01 or more occupants per room
    'B25014_011', # Estimate!!Total:!!Renter occupied:!!1.01 to 1.50 occupants per room
    'B25014_012', # Estimate!!Total:!!Renter occupied:!!1.51 to 2.00 occupants per room
    'B25014_013', # Estimate!!Total:!!Renter occupied:!!2.01 or more occupants per room
    # UNITS IN STRUCTURE
    'B25024_001', # Estimate!!Total:
    'B25024_007', # Estimate!!Total:!!10 to 19
    'B25024_008', # Estimate!!Total:!!20 to 49
    'B25024_009', # Estimate!!Total:!!50 or more
    # LIVING ARRANGEMENTS OF ADULTS 18 YEARS AND OVER BY AGE
    'B09021_022', # Estimate!!Total:!!65 years and over:
    'B09021_001', # Estimate!!Total:
    # SEX BY AGE
    'B01001_003', # Estimate!!Total:!!Male:!!Under 5 years
    'B01001_004', # Estimate!!Total:!!Male:!!5 to 9 years
    'B01001_005', # Estimate!!Total:!!Male:!!10 to 14 years
    'B01001_006', # Estimate!!Total:!!Male:!!15 to 17 years
    'B01001_027', # Estimate!!Total:!!Female:!!Under 5 years
    'B01001_028', # Estimate!!Total:!!Female:!!5 to 9 years
    'B01001_029', # Estimate!!Total:!!Female:!!10 to 14 years
    'B01001_030', # Estimate!!Total:!!Female:!!15 to 17 years
    'B01001_020', # Estimate!!Total:!!Male:!!65 and 66 years
    'B01001_021', # Estimate!!Total:!!Male:!!67 to 69 years
    'B01001_022', # Estimate!!Total:!!Male:!!70 to 74 years
    'B01001_023', # Estimate!!Total:!!Male:!!75 to 79 years
    'B01001_024', # Estimate!!Total:!!Male:!!80 to 84 years
    'B01001_025', # Estimate!!Total:!!Male:!!85 years and over
    'B01001_044', # Estimate!!Total:!!Female:!!65 and 66 years
    'B01001_045', # Estimate!!Total:!!Female:!!67 to 69 years
    'B01001_046', # Estimate!!Total:!!Female:!!70 to 74 years
    'B01001_047', # Estimate!!Total:!!Female:!!75 to 79 years
    'B01001_048', # Estimate!!Total:!!Female:!!80 to 84 years
    'B01001_049', # Estimate!!Total:!!Female:!!85 years and over
    # ALLOCATION OF ABILITY TO SPEAK ENGLISH FOR THE POPULATION 5 YEARS AND OVER
    'B99163_001', # Estimate!!Total:
    'B99163_005', # Estimate!!Total:!!Speak other languages:!!Ability to speak English --!!Not allocated
    # HISPANIC OR LATINO ORIGIN BY RACE
    'B03002_003', # Estimate!!Total:!!Not Hispanic or Latino:!!White alone
    'B03002_003', # Estimate!!Total:!!Not Hispanic or Latino:!!White alone
    'B03002_001', # Estimate!!Total:
    # RACE 
    'B02001_004', # Estimate!!Total:!!American Indian and Alaska Native alone
    'B02001_001', # Estimate!!Total:
    'B02001_003', # Estimate!!Total:!!Black or African American alone
    'B02001_006', # Estimate!!Total:!!Native Hawaiian and Other Pacific Islander alone
    'B02001_007', # Estimate!!Total:!!Some other race alone
    'B02001_008', # Estimate!!Total:!!Two or more races:
    'B02001_005', # Estimate!!Total:!!Asian alone
    # HISPANIC OR LATINO ORIGIN
    'B03003_003', # Estimate!!Total:!!Hispanic or Latino
    'B03003_001', # Estimate!!Total:
    # OCCUPANCY STATUS
    'B25002_001', # Estimate!!Total:
    'B25002_003', # Estimate!!Total:!!Vacant
    # EDUCATIONAL ATTAINMENT FOR THE POPULATION 25 YEARS AND OVER
    'B15003_001', # Estimate!!Total:
    'B15003_016', # Estimate!!Total:!!12th grade, no diploma
    'B15003_017', # Estimate!!Total:!!Regular high school diploma
    'B15003_018', # Estimate!!Total:!!GED or alternative credential
    'B15003_019', # Estimate!!Total:!!Some college, less than 1 year
    'B15003_020', # Estimate!!Total:!!Some college, 1 or more years, no degree
    'B15003_021', # Estimate!!Total:!!Associate's degree
    'B15003_022', # Estimate!!Total:!!Bachelor's degree
    'B15003_023', # Estimate!!Total:!!Master's degree
    'B15003_024', # Estimate!!Total:!!Professional school degree
    'B15003_025', # Estimate!!Total:!!Doctorate degree
    # GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME IN THE PAST 12 MONTHS
    'B25070_001', # Estimate!!Total:
    # POVERTY STATUS IN THE PAST 12 MONTHS BY AGE
    'B17020_001', # Estimate!!Total:
    # RATIO OF INCOME TO POVERTY LEVEL IN THE PAST 12 MONTHS
    'C17002_001', # Estimate!!Total:
    'C17002_002', # Estimate!!Total:!!Under .50
    'C17002_003', # Estimate!!Total:!!.50 to .99
    'C17002_004', # Estimate!!Total:!!1.00 to 1.24
    # SEX BY AGE BY DISABILITY STATUS
    'B18101_025', # Estimate!!Total:!!Female:!!5 to 17 years:
    'B18101_026', # Estimate!!Total:!!Female:!!5 to 17 years:!!With a disability
    'B18101_006', # Estimate!!Total:!!Male:!!5 to 17 years:
    'B18101_007', # Estimate!!Total:!!Male:!!5 to 17 years:!!With a disability
    # AGE BY DISABILITY STATUS BY POVERTY STATUS
    'C18130_009', # Estimate!!Total:!!18 to 64 years:
    'C18130_010', # Estimate!!Total:!!18 to 64 years:!!With a disability:
    'C18130_016', # Estimate!!Total:!!65 years and over:
    'C18130_017', # Estimate!!Total:!!65 years and over:!!With a disability:
    # GROUP QUARTERS POPULATION
    'B26001_001', # Estimate!!Total:
    # FAMILY TYPE BY PRESENCE AND AGE OF RELATED CHILDREN UNDER 18 YEARS
    'B11004_012', # Estimate!!Total:!!Other family:!!Male householder, no spouse present:!!With related children of the householder under 18 years:!!Under 6 years and 6 to 17 years
    'B11004_018', # Estimate!!Total:!!Other family:!!Female householder, no spouse present:!!With related children of the householder under 18 years:!!Under 6 years and 6 to 17 years
    # single parent household; only available in decennial census 
    # 'B09008_001', 
    # 'B09008_010',
    # 'B09008_011',
    # 'B09008_012',
    # POVERTY STATUS IN THE PAST 12 MONTHS OF FAMILIES BY HOUSEHOLD TYPE BY NUMBER OF OWN CHILDREN UNDER 18 YEARS
    'B17023_001', # Estimate!!Total:
    'B17023_016', # Estimate!!Total:!!Income in the past 12 months below poverty level:!!Other families:!!Female householder, no spouse present:!!1 or 2 own children of the householder
    'B17023_017', # Estimate!!Total:!!Income in the past 12 months below poverty level:!!Other families:!!Female householder, no spouse present:!!3 or 4 own children of the householder
    'B17023_018', # Estimate!!Total:!!Income in the past 12 months below poverty level:!!Other families:!!Female householder, no spouse present:!!5 or more own children of the householder
    # RECEIPT OF FOOD STAMPS/SNAP IN THE PAST 12 MONTHS BY PRESENCE OF CHILDREN UNDER 18 YEARS BY HOUSEHOLD TYPE FOR HOUSEHOLDS
    'B22002_001' # Estimate!!Total:
  )

ct19_1 <- get_acs(
  geography = 'tract',
  state = "Arizona",
  county =  "Coconino",
  survey = 'acs5',
  year = 2019,
  variables = vars,
  output = "wide",
  geometry = FALSE
)

census_tract_data <-
  separate(
    data = ct19_1,
    col = "NAME",
    into = c("CENSUS_TRACT", "COUNTY", "STATE"),
    sep = ","
  )

#SOCIOECONOMIC STATUS:

census_tract_data <- census_tract_data %>%
  mutate(totpop = B01003_001E,
         per_poverty = (C17002_002E + C17002_003E) / C17002_001E,
         per_unemployed = B23025_005E / B23025_003E,
         per_capita_income = B19301_001E
         )

#LANGUAGE AND EDUCATION:

census_tract_data <- census_tract_data %>%
  mutate(per_less_hs_grad = 1 - ((
    B15003_016E + B15003_017E + B15003_018E + B15003_019E +
      B15003_020E + B15003_021E + B15003_022E + B15003_023E +
      B15003_024E + B15003_025E
  ) / B15003_001E),
  per_esl = B99163_005E / B99163_001E
  )


#DEMOGRAPHICS:

census_tract_data <- census_tract_data %>%
  mutate(
    per_over_65 =  B09021_022E / B09021_001E,
    per_under_17 = (
      B01001_003E + B01001_004E + B01001_005E + B01001_006E +
        B01001_027E + B01001_028E + B01001_029E + B01001_030E
    ) / B01003_001E,
    per_disabled = (
      B18101_026E + B18101_007E + C18130_010E + C18130_017E
    ) / (
      B18101_025E + B18101_006E + C18130_009E + C18130_016E
    ) #,
    # only available in decennial census 
    # per_single_parent = (B09008_010E + B09008_011E + B09008_012E) / B09008_001E
  )

#HOUSING AND TRANSPORTATION:

census_tract_data <- census_tract_data %>%
  mutate(
    per_multi_dwell = (B25024_007E + B25024_008E + B25024_009E) / B25024_001E,
    per_mobile_dwell = (
      B25033_006E + B25033_007E + B25033_012E + B25033_013E
    ) / B25033_001E,
    per_crowd_dwell = (
      B25014_005E + B25014_006E + B25014_007E + B25014_011E +
        B25014_012E + B25014_013E
    ) / B25014_001E,
    per_no_veh_avail = (B25044_003E + B25044_010E) / B25044_001E,
    per_group_dwell = B26001_001E / B01003_001E
  )

#RACIAL AND ETHNIC MAKEUP:

census_tract_data <- census_tract_data %>%
  mutate(
    minority = 1 - (B03002_003E / B03002_001E),
    native_american = B02001_004E / B02001_001E,
    asian = B02001_005E / B02001_001E,
    black = B02001_003E / B02001_001E,
    hispanic = B03003_003E / B03003_001E,
    pacific_islander = B02001_006E / B02001_001E,
    other_race = B02001_007E / B02001_001E,
    multi_race = B02001_008E / B02001_001E,
    white = B03002_003E / B03002_001E
  )

#OPTIONAL VARIABLES:

census_tract_data <- census_tract_data %>%
  mutate(
    homesoccpd = 1 - (B25002_003E / B25002_001E),
    renter = B25003_003E / B25003_001E,
    rentburden = (B25070_007E + B25070_008E + B25070_009E + B25070_010E
    ) / B25070_001E,
    rentaspercentincome = (B25071_001E / 100),
    over65alone = B11007_003E / B11007_001E,
    built_before_1969 = (B25034_008E + B25034_009E + B25034_010E + B25034_011E) / B25034_001E,
    severe_poverty = C17002_002E / C17002_001E,
    mod_pov = C17002_004E / C17002_001E,
    single_mother_poverty = (B17023_016E + B17023_017E + B17023_018E) / B17023_001E
  )

#RANKING#

a <- census_tract_data$rank_pov <-  rank(x = -census_tract_data$per_poverty,
                    na.last = "keep",
                    ties.method = "max")

b <- census_tract_data$rank_unemployed <-  rank(x = -census_tract_data$per_unemployed,
                              na.last = "keep",
                              ties.method = "max")

c <-
  census_tract_data$rank_per_capita_income <-
  rank(x = census_tract_data$per_capita_income,
       na.last = "keep",
       ties.method = "max") #Note that we are not taking the inverse here because the higher the Per Capita Income, the greater the Adaptive Capacity of a given blockgroup

d <-
  census_tract_data$rank_per_less_hs_grad <-
  rank(x = -census_tract_data$per_less_hs_grad,
       na.last = "keep",
       ties.method = "max")

e <-
  census_tract_data$rank_per_esl <-
  rank(x = -census_tract_data$per_esl,
       na.last = "keep",
       ties.method = "max")

f <-
  census_tract_data$rank_per_over_65 <-
  rank(x = -census_tract_data$per_over_65,
       na.last = "keep",
       ties.method = "max")

g <-
  census_tract_data$rank_per_under_17 <-
  rank(x = -census_tract_data$per_under_17,
       na.last = "keep",
       ties.method = "max")

h <-
  census_tract_data$rank_per_disabled <-
  rank(x = -census_tract_data$per_disabled,
       na.last = "keep",
       ties.method = "max")

# i <-
#   census_tract_data$RNKSNGPNT <-
#   rank(x = -census_tract_data$SNGPNT,
#        na.last = "keep",
#        ties.method = "max")

j <-
  census_tract_data$rank_per_multi_dwell <-
  rank(x = -census_tract_data$per_multi_dwell,
       na.last = "keep",
       ties.method = "max")

k <-
  census_tract_data$rank_per_mobile_dwell <-
  rank(x = -census_tract_data$per_mobile_dwell,
       na.last = "keep",
       ties.method = "max")

l <-
  census_tract_data$rank_per_crowd_dwell <-
  rank(x = -census_tract_data$per_crowd_dwell,
       na.last = "keep",
       ties.method = "max")

m <-
  census_tract_data$rank_per_no_veh_avail <-
  rank(x = -census_tract_data$per_no_veh_avail,
       na.last = "keep",
       ties.method = "max")

n <-
  census_tract_data$rank_per_group_dwell <-
  rank(x = -census_tract_data$per_group_dwell,
       na.last = "keep",
       ties.method = "max")

#Sum The Ranks

census_tract_data$sum_rank = a + b + c + d + e + f + g + h + j + k + l + m + n # + i

#Derive the Adaptive Capacity Index

census_tract_data$adaptive_capacity_index <- dplyr::percent_rank(census_tract_data$sum_rank)

#**This Finds How Much Each Variable Contributed to The Final Percent Rank (Optional)**

# This Determines the Percentage Contribution to Final Rank
geoid <- which(colnames(census_tract_data) == "GEOID")
a <- which(colnames(census_tract_data) == "rank_pov")
z <- which(colnames(census_tract_data) == "rank_per_group_dwell")
cols <- as.vector(names(census_tract_data[a:z]))
Func <- function(x) {
  round((abs(x) / abs(census_tract_data$sum_rank)), 2) * 100
}
rank_percent <-
  dplyr::mutate_at(.tbl = census_tract_data,
                   .vars = cols,
                   .funs = Func)
rank_percent <- rank_percent[c(geoid, a:z)]
census_tract_data <- dplyr::right_join(census_tract_data, rank_percent, by = "GEOID")

#### **Now to Bring in Geometry From Tigris**

census_tract_data_spatial <- tigris::tracts(
  state = "Arizona",
  county = "Coconino",
  cb = TRUE
)

census_tract_data_spatial <- tigris::geo_join(
  spatial_data = census_tract_data_spatial,
  data_frame = census_tract_data,
  by_sp = "GEOID",
  by_df = "GEOID"
)

# save to disk 
write_rds(census_tract_data_spatial, "data/census_tract_data_spatial.rds")

# total population 
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = totpop)) +
  scale_fill_viridis_b() +
  theme_void()

# adaptive_capacity_index
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = adaptive_capacity_index)) +
  scale_fill_viridis_b() +
  theme_void()

# living in poverty
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_poverty)) +
  scale_fill_viridis_b() +
  theme_void()

# unemployed
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_unemployed)) +
  scale_fill_viridis_b() +
  theme_void()

# per capita income 
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_capita_income)) +
  scale_fill_viridis_b() +
  theme_void()

# percent of population less than HS education 
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_less_hs_grad)) +
  scale_fill_viridis_b() +
  theme_void()

# percent ESL 
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_esl)) +
  scale_fill_viridis_b() +
  theme_void()

# percent under age 17 
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_under_17)) +
  scale_fill_viridis_b() +
  theme_void()

# percent age 65 and older  
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_over_65)) +
  scale_fill_viridis_b() +
  theme_void()

# percent disabled 
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_disabled)) +
  scale_fill_viridis_b() +
  theme_void()

# percent living in multi unit structure 
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_multi_dwell)) +
  scale_fill_viridis_b() +
  theme_void()

# percent living in mobile dwelling 
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_mobile_dwell)) +
  scale_fill_viridis_b() +
  theme_void()

# percent living in crowded dwelling 
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_crowd_dwell)) +
  scale_fill_viridis_b() +
  theme_void()

# percent with no vehicle access 
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_no_veh_avail)) +
  scale_fill_viridis_b() +
  theme_void()

# percent living in group quarters 
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = per_group_dwell)) +
  scale_fill_viridis_b() +
  theme_void()

# percent minority 
census_tract_data_spatial %>%
  ggplot() +
  geom_sf(mapping = aes(fill = minority)) +
  scale_fill_viridis_b() +
  theme_void()

